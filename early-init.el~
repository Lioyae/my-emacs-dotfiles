;;; early-init.el --- Windows 11 Optimized Configuration -*- lexical-binding: t -*-

;; 1. 垃圾回收优化
;; 在启动阶段大幅提高 GC 阈值，减少启动过程中的回收次数
(setq gc-cons-threshold most-positive-fixnum
      gc-cons-percentage 0.6)

;; 2. 界面早起平滑处理 (减少闪烁)
;; 在窗口创建前禁用不必要的 UI 元素
(push '(menu-bar-lines . 0) default-frame-alist)
(push '(tool-bar-lines . 0) default-frame-alist)
(push '(vertical-scroll-bars) default-frame-alist)

;; 如果你使用特定字体，在这里设置可以避免启动后重新计算排版导致的闪烁
(set-face-attribute 'default nil :font "JetBrainsMono Nerd Font")

;; 3. 性能优化：文件处理与进程
;; 禁用不必要的文件处理器，加快 autoload 载入速度
(setq file-name-handler-alist nil)

;; 4. 针对 Windows 的特定路径与编码优化
(when (eq system-type 'windows-nt)
  ;; 尽量避免使用强制的 UTF-8 导致部分系统命令乱码，
  ;; 但在 early-init 阶段，我们主要关注后续加载的编码预设
  (set-language-environment "UTF-8"))

;; 5. 禁用包管理器早期初始化
;; 我们通常在 init.el 中手动调用 (package-initialize) 以获得更好的控制
(setq package-enable-at-startup nil)

;; 6. 启动完成后恢复 GC 阈值
;; 使用 hook 确保启动后内存占用不会无限飙升
(add-hook 'emacs-startup-hook
          (lambda ()
            (setq gc-cons-threshold (* 16 1024 1024) ; 16MB
                  gc-cons-percentage 0.1)
            ;; 恢复文件处理器
            (setq file-name-handler-alist default-file-name-handler-alist)))

;; 7. 抑制不必要的警告
(setq native-comp-async-report-warnings-errors 'silent)
